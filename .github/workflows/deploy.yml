name: Deploy Production

on:
  push:
    branches: ["master"]

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
# ==============================
# BUILD
# ==============================
  build:
    name: Build & Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, intl, pdo, pdo_mysql, gd, bcmath
          coverage: none

      - name: Validate composer
        run: composer validate --no-check-all

      - name: Install composer deps (build check)
        run: composer install --no-dev --prefer-dist --no-interaction

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build frontend (auto detect)
        run: |
          if [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm install --frozen-lockfile
            pnpm build
          elif [ -f yarn.lock ]; then
            yarn install --frozen-lockfile
            yarn build
          elif [ -f package-lock.json ]; then
            npm ci
            npm run build
          else
            echo "No frontend build"
          fi

      - name: Package artifact
        run: |
          rm -rf .git tests node_modules vendor storage bootstrap/cache
          tar -czf app.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: app.tar.gz

# ==============================
# DEPLOY
# ==============================
  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

# ==============================
# PREPARE RELEASE
# ==============================
      - name: Upload & extract release
        run: |
          RELEASE=$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::7}
          echo "RELEASE=$RELEASE" >> $GITHUB_ENV

          ssh -p "${{ secrets.SSH_PORT }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "mkdir -p ${{ secrets.APP_DIR }}/releases/$RELEASE"

          scp -P "${{ secrets.SSH_PORT }}" app.tar.gz \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.APP_DIR }}/releases/$RELEASE/

          ssh -p "${{ secrets.SSH_PORT }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ secrets.APP_DIR }}/releases/$RELEASE && tar -xzf app.tar.gz && rm app.tar.gz"

# ==============================
# ENSURE SHARED DIRS
# ==============================
      - name: Ensure shared directories
        run: |
          ssh -p "${{ secrets.SSH_PORT }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            mkdir -p ${{ secrets.APP_DIR }}/shared/storage
            mkdir -p ${{ secrets.APP_DIR }}/shared/bootstrap-cache

            chgrp -R www-data ${{ secrets.APP_DIR }}/shared || true
            chmod -R ug+rwx ${{ secrets.APP_DIR }}/shared
            "

# ==============================
# LINK SHARED
# ==============================
      - name: Link shared resources
        run: |
          ssh -p "${{ secrets.SSH_PORT }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.APP_DIR }}/releases/$RELEASE

            ln -sfn ${{ secrets.APP_DIR }}/shared/storage storage
            ln -sfn ${{ secrets.APP_DIR }}/shared/.env .env

            rm -rf bootstrap/cache
            ln -sfn ${{ secrets.APP_DIR }}/shared/bootstrap-cache bootstrap/cache
            "

# ==============================
# INSTALL & OPTIMIZE
# ==============================
      - name: Composer install & optimize
        run: |
          ssh -p "${{ secrets.SSH_PORT }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            set -e
            cd ${{ secrets.APP_DIR }}/releases/$RELEASE

            composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

            php artisan key:generate --force || true
            php artisan storage:link || true
            php artisan config:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            "

# ==============================
# DATABASE
# ==============================
      - name: Run migrations
        run: |
          ssh -p "${{ secrets.SSH_PORT }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.APP_DIR }}/releases/$RELEASE
            php artisan migrate --force
            "

# ==============================
# ACTIVATE
# ==============================
      - name: Activate release
        run: |
          ssh -p "${{ secrets.SSH_PORT }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            ln -sfn ${{ secrets.APP_DIR }}/releases/$RELEASE ${{ secrets.APP_DIR }}/current

            sudo systemctl reload php8.2-fpm || true
            sudo systemctl reload nginx || true
            "

# ==============================
# POST DEPLOY
# ==============================
      - name: Restart queues
        run: |
          ssh -p "${{ secrets.SSH_PORT }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.APP_DIR }}/current
            php artisan queue:restart || true
            "

# ==============================
# CLEANUP
# ==============================
      - name: Prune old releases
        run: |
          ssh -p "${{ secrets.SSH_PORT }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.APP_DIR }}/releases
            ls -1t | tail -n +6 | xargs -r rm -rf
            "
